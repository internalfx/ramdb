'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _utils = require('./utils');

var _isArray = require('mout/lang/isArray');

var _isArray2 = _interopRequireDefault(_isArray);

var _merge = require('mout/object/merge');

var _merge2 = _interopRequireDefault(_merge);

var _omit = require('mout/object/omit');

var _omit2 = _interopRequireDefault(_omit);

var _clone = require('mout/lang/clone');

var _clone2 = _interopRequireDefault(_clone);

var _immutable = require('immutable');

var _immutable2 = _interopRequireDefault(_immutable);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var BaseSecondaryIndex = {

  set: function set(keyList, value) {
    if (!(0, _isArray2.default)(keyList)) {
      keyList = [keyList];
    }

    var key = keyList.shift() || null;
    var pos = (0, _utils.binarySearch)(this.keys, key);

    if (keyList.length === 0) {
      if (pos.found) {
        var dataLocation = (0, _utils.binarySearch)(this.values[pos.index], value);
        if (!dataLocation.found) {
          (0, _utils.insertAt)(this.values[pos.index], dataLocation.index, value);
        }
      } else {
        (0, _utils.insertAt)(this.keys, pos.index, key);
        (0, _utils.insertAt)(this.values, pos.index, [value]);
      }
    } else {
      if (pos.found) {
        this.values[pos.index].set(keyList, value);
      } else {
        (0, _utils.insertAt)(this.keys, pos.index, key);
        var newIndex = createIndex();
        newIndex.set(keyList, value);
        (0, _utils.insertAt)(this.values, pos.index, newIndex);
      }
    }
  },

  get: function get(keyList) {
    if (!(0, _isArray2.default)(keyList)) {
      keyList = [keyList];
    }

    var key = keyList.shift() || null;
    var pos = (0, _utils.binarySearch)(this.keys, key);

    if (keyList.length === 0) {
      if (pos.found) {
        if (this.values[pos.index].isIndex) {
          return this.values[pos.index].getAll();
        } else {
          return this.values[pos.index];
        }
      } else {
        return [];
      }
    } else {
      if (pos.found) {
        return this.values[pos.index].get(keyList);
      } else {
        return [];
      }
    }
  },

  getAll: function getAll() {
    var results = [];
    this.values.forEach(function (value) {
      if (value.isIndex) {
        results = results.concat(value.getAll());
      } else {
        results = results.concat(value);
      }
    });
    return results;
  },

  query: function query(_query) {
    var leftKeys = undefined;
    var rightKeys = undefined;

    if (_query['>']) {
      leftKeys = _query['>'];
      _query.leftInclusive = false;
    } else if (_query['>=']) {
      leftKeys = _query['>='];
      _query.leftInclusive = true;
    }

    if (_query['<']) {
      rightKeys = _query['<'];
      _query.rightInclusive = false;
    } else if (_query['<=']) {
      rightKeys = _query['<='];
      _query.rightInclusive = true;
    }

    if (leftKeys.length !== rightKeys.length) {
      throw new Error('Key arrays must be same length');
    }

    return this.between(leftKeys, rightKeys, (0, _omit2.default)(_query, ['>', '>=', '<', '<=']));
  },

  between: function between(leftKeys, rightKeys, opts) {
    opts = (0, _merge2.default)({
      leftInclusive: true,
      rightInclusive: false,
      limit: undefined,
      offset: 0
    }, opts);

    var results = this._between(leftKeys, rightKeys, opts);

    if (opts.limit) {
      return results.slice(opts.offset, opts.limit + opts.offset);
    } else {
      return results.slice(opts.offset);
    }
  },

  _between: function _between(leftKeys, rightKeys, opts) {
    var results = [];

    var leftKey = leftKeys.shift();
    var rightKey = rightKeys.shift();

    var pos = undefined;

    if (leftKey !== undefined) {
      pos = (0, _utils.binarySearch)(this.keys, leftKey);
    } else {
      pos = {
        found: false,
        index: 0
      };
    }

    if (leftKeys.length === 0) {
      if (pos.found && opts.leftInclusive === false) {
        pos.index += 1;
      }

      for (var i = pos.index; i < this.keys.length; i += 1) {
        if (rightKey !== undefined) {
          if (opts.rightInclusive) {
            if (this.keys[i] > rightKey) {
              break;
            }
          } else {
            if (this.keys[i] >= rightKey) {
              break;
            }
          }
        }

        if (this.values[i].isIndex) {
          results = results.concat(this.values[i].getAll());
        } else {
          results = results.concat(this.values[i]);
        }

        if (opts.limit) {
          if (results.length >= opts.limit + opts.offset) {
            break;
          }
        }
      }
    } else {
      for (var i = pos.index; i < this.keys.length; i += 1) {
        var currKey = this.keys[i];
        if (currKey > rightKey) {
          break;
        }

        if (this.values[i].isIndex) {
          if (currKey === leftKey) {
            results = results.concat(this.values[i]._between((0, _clone2.default)(leftKeys), rightKeys.map(function () {
              return undefined;
            }), opts));
          } else if (currKey === rightKey) {
            results = results.concat(this.values[i]._between(leftKeys.map(function () {
              return undefined;
            }), (0, _clone2.default)(rightKeys), opts));
          } else {
            results = results.concat(this.values[i].getAll());
          }
        } else {
          results = results.concat(this.values[i]);
        }

        if (opts.limit) {
          if (results.length >= opts.limit + opts.offset) {
            break;
          }
        }
      }
    }

    if (opts.limit) {
      return results.slice(0, opts.limit + opts.offset);
    } else {
      return results;
    }
  },

  remove: function remove(keyList, value) {
    if (!(0, _isArray2.default)(keyList)) {
      keyList = [keyList];
    }

    var key = keyList.shift();
    var pos = (0, _utils.binarySearch)(this.keys, key);

    if (keyList.length === 0) {
      if (pos.found) {
        var dataLocation = (0, _utils.binarySearch)(this.values[pos.index], value);
        if (dataLocation.found) {
          (0, _utils.removeAt)(this.values[pos.index], dataLocation.index);
          if (this.values[pos.index].length === 0) {
            (0, _utils.removeAt)(this.keys, pos.index);
            (0, _utils.removeAt)(this.values, pos.index);
          }
        }
      }
    } else {
      if (pos.found) {
        this.values[pos.index].delete(keyList, value);
      }
    }
  },

  clear: function clear() {
    this.keys = [];
    this.values = [];
  },

  insertRecord: function insertRecord(data) {
    if (!_immutable2.default.Map.isMap(data)) {
      throw new Error('data must be an Immutable Map');
    }

    var keyList = this.fieldList.map(function (field) {
      return data.get(field, null);
    });

    this.set(keyList, data.get('id'));
  },

  removeRecord: function removeRecord(data) {
    if (!_immutable2.default.Map.isMap(data)) {
      throw new Error('data must be an Immutable Map');
    }

    var keyList = this.fieldList.map(function (field) {
      return data.get(field, null);
    });

    this.remove(keyList, data.get('id'));
  },

  updateRecord: function updateRecord(data) {
    this.removeRecord(data);
    this.insertRecord(data);
  }
};
// import isString from 'mout/lang/isString'

var createIndex = function createIndex() {
  var fieldList = arguments.length <= 0 || arguments[0] === undefined ? [] : arguments[0];

  var index = Object.create(BaseSecondaryIndex);

  if (!(0, _isArray2.default)(fieldList)) {
    throw new Error('fieldList must be an array.');
  }

  index.fieldList = fieldList;
  index.isIndex = true;
  index.keys = [];
  index.values = [];

  return index;
};

exports.default = createIndex;
//# sourceMappingURL=data:application/json;base64,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SyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUE7QUFDcEIsT0FBSyxDQUFDLElBQUksR0FBRyxFQUFFLENBQUE7QUFDZixPQUFLLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQTs7QUFFakIsU0FBTyxLQUFLLENBQUE7Q0FDYixDQUFBOztrQkFFYyxXQUFXIiwiZmlsZSI6InNlY29uZGFyeUluZGV4LmVzNiIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHtiaW5hcnlTZWFyY2gsIGluc2VydEF0LCByZW1vdmVBdH0gZnJvbSAnLi91dGlscydcbi8vIGltcG9ydCBpc1N0cmluZyBmcm9tICdtb3V0L2xhbmcvaXNTdHJpbmcnXG5pbXBvcnQgaXNBcnJheSBmcm9tICdtb3V0L2xhbmcvaXNBcnJheSdcbmltcG9ydCBtZXJnZSBmcm9tICdtb3V0L29iamVjdC9tZXJnZSdcbmltcG9ydCBvbWl0IGZyb20gJ21vdXQvb2JqZWN0L29taXQnXG5pbXBvcnQgY2xvbmUgZnJvbSAnbW91dC9sYW5nL2Nsb25lJ1xuaW1wb3J0IEltbXV0YWJsZSBmcm9tICdpbW11dGFibGUnXG5cbnZhciBCYXNlU2Vjb25kYXJ5SW5kZXggPSB7XG5cbiAgc2V0OiBmdW5jdGlvbiAoa2V5TGlzdCwgdmFsdWUpIHtcbiAgICBpZiAoIWlzQXJyYXkoa2V5TGlzdCkpIHtcbiAgICAgIGtleUxpc3QgPSBba2V5TGlzdF1cbiAgICB9XG5cbiAgICBsZXQga2V5ID0ga2V5TGlzdC5zaGlmdCgpIHx8IG51bGxcbiAgICBsZXQgcG9zID0gYmluYXJ5U2VhcmNoKHRoaXMua2V5cywga2V5KVxuXG4gICAgaWYgKGtleUxpc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICBpZiAocG9zLmZvdW5kKSB7XG4gICAgICAgIGxldCBkYXRhTG9jYXRpb24gPSBiaW5hcnlTZWFyY2godGhpcy52YWx1ZXNbcG9zLmluZGV4XSwgdmFsdWUpXG4gICAgICAgIGlmICghZGF0YUxvY2F0aW9uLmZvdW5kKSB7XG4gICAgICAgICAgaW5zZXJ0QXQodGhpcy52YWx1ZXNbcG9zLmluZGV4XSwgZGF0YUxvY2F0aW9uLmluZGV4LCB2YWx1ZSlcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaW5zZXJ0QXQodGhpcy5rZXlzLCBwb3MuaW5kZXgsIGtleSlcbiAgICAgICAgaW5zZXJ0QXQodGhpcy52YWx1ZXMsIHBvcy5pbmRleCwgW3ZhbHVlXSlcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHBvcy5mb3VuZCkge1xuICAgICAgICB0aGlzLnZhbHVlc1twb3MuaW5kZXhdLnNldChrZXlMaXN0LCB2YWx1ZSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGluc2VydEF0KHRoaXMua2V5cywgcG9zLmluZGV4LCBrZXkpXG4gICAgICAgIGxldCBuZXdJbmRleCA9IGNyZWF0ZUluZGV4KClcbiAgICAgICAgbmV3SW5kZXguc2V0KGtleUxpc3QsIHZhbHVlKVxuICAgICAgICBpbnNlcnRBdCh0aGlzLnZhbHVlcywgcG9zLmluZGV4LCBuZXdJbmRleClcbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgZ2V0OiBmdW5jdGlvbiAoa2V5TGlzdCkge1xuICAgIGlmICghaXNBcnJheShrZXlMaXN0KSkge1xuICAgICAga2V5TGlzdCA9IFtrZXlMaXN0XVxuICAgIH1cblxuICAgIGxldCBrZXkgPSBrZXlMaXN0LnNoaWZ0KCkgfHwgbnVsbFxuICAgIGxldCBwb3MgPSBiaW5hcnlTZWFyY2godGhpcy5rZXlzLCBrZXkpXG5cbiAgICBpZiAoa2V5TGlzdC5sZW5ndGggPT09IDApIHtcbiAgICAgIGlmIChwb3MuZm91bmQpIHtcbiAgICAgICAgaWYgKHRoaXMudmFsdWVzW3Bvcy5pbmRleF0uaXNJbmRleCkge1xuICAgICAgICAgIHJldHVybiB0aGlzLnZhbHVlc1twb3MuaW5kZXhdLmdldEFsbCgpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVzW3Bvcy5pbmRleF1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFtdXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChwb3MuZm91bmQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVzW3Bvcy5pbmRleF0uZ2V0KGtleUxpc3QpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gW11cbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgZ2V0QWxsOiBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IHJlc3VsdHMgPSBbXVxuICAgIHRoaXMudmFsdWVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICBpZiAodmFsdWUuaXNJbmRleCkge1xuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5jb25jYXQodmFsdWUuZ2V0QWxsKCkpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5jb25jYXQodmFsdWUpXG4gICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gcmVzdWx0c1xuICB9LFxuXG4gIHF1ZXJ5OiBmdW5jdGlvbiAocXVlcnkpIHtcbiAgICBsZXQgbGVmdEtleXNcbiAgICBsZXQgcmlnaHRLZXlzXG5cbiAgICBpZiAocXVlcnlbJz4nXSkge1xuICAgICAgbGVmdEtleXMgPSBxdWVyeVsnPiddXG4gICAgICBxdWVyeS5sZWZ0SW5jbHVzaXZlID0gZmFsc2VcbiAgICB9IGVsc2UgaWYgKHF1ZXJ5Wyc+PSddKSB7XG4gICAgICBsZWZ0S2V5cyA9IHF1ZXJ5Wyc+PSddXG4gICAgICBxdWVyeS5sZWZ0SW5jbHVzaXZlID0gdHJ1ZVxuICAgIH1cblxuICAgIGlmIChxdWVyeVsnPCddKSB7XG4gICAgICByaWdodEtleXMgPSBxdWVyeVsnPCddXG4gICAgICBxdWVyeS5yaWdodEluY2x1c2l2ZSA9IGZhbHNlXG4gICAgfSBlbHNlIGlmIChxdWVyeVsnPD0nXSkge1xuICAgICAgcmlnaHRLZXlzID0gcXVlcnlbJzw9J11cbiAgICAgIHF1ZXJ5LnJpZ2h0SW5jbHVzaXZlID0gdHJ1ZVxuICAgIH1cblxuICAgIGlmIChsZWZ0S2V5cy5sZW5ndGggIT09IHJpZ2h0S2V5cy5sZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignS2V5IGFycmF5cyBtdXN0IGJlIHNhbWUgbGVuZ3RoJylcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5iZXR3ZWVuKGxlZnRLZXlzLCByaWdodEtleXMsIG9taXQocXVlcnksIFsnPicsICc+PScsICc8JywgJzw9J10pKVxuICB9LFxuXG4gIGJldHdlZW46IGZ1bmN0aW9uIChsZWZ0S2V5cywgcmlnaHRLZXlzLCBvcHRzKSB7XG4gICAgb3B0cyA9IG1lcmdlKHtcbiAgICAgIGxlZnRJbmNsdXNpdmU6IHRydWUsXG4gICAgICByaWdodEluY2x1c2l2ZTogZmFsc2UsXG4gICAgICBsaW1pdDogdW5kZWZpbmVkLFxuICAgICAgb2Zmc2V0OiAwXG4gICAgfSwgb3B0cylcblxuICAgIGxldCByZXN1bHRzID0gdGhpcy5fYmV0d2VlbihsZWZ0S2V5cywgcmlnaHRLZXlzLCBvcHRzKVxuXG4gICAgaWYgKG9wdHMubGltaXQpIHtcbiAgICAgIHJldHVybiByZXN1bHRzLnNsaWNlKG9wdHMub2Zmc2V0LCBvcHRzLmxpbWl0ICsgb3B0cy5vZmZzZXQpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiByZXN1bHRzLnNsaWNlKG9wdHMub2Zmc2V0KVxuICAgIH1cbiAgfSxcblxuICBfYmV0d2VlbjogZnVuY3Rpb24gKGxlZnRLZXlzLCByaWdodEtleXMsIG9wdHMpIHtcbiAgICBsZXQgcmVzdWx0cyA9IFtdXG5cbiAgICBsZXQgbGVmdEtleSA9IGxlZnRLZXlzLnNoaWZ0KClcbiAgICBsZXQgcmlnaHRLZXkgPSByaWdodEtleXMuc2hpZnQoKVxuXG4gICAgbGV0IHBvc1xuXG4gICAgaWYgKGxlZnRLZXkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcG9zID0gYmluYXJ5U2VhcmNoKHRoaXMua2V5cywgbGVmdEtleSlcbiAgICB9IGVsc2Uge1xuICAgICAgcG9zID0ge1xuICAgICAgICBmb3VuZDogZmFsc2UsXG4gICAgICAgIGluZGV4OiAwXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGxlZnRLZXlzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgaWYgKHBvcy5mb3VuZCAmJiBvcHRzLmxlZnRJbmNsdXNpdmUgPT09IGZhbHNlKSB7XG4gICAgICAgIHBvcy5pbmRleCArPSAxXG4gICAgICB9XG5cbiAgICAgIGZvciAobGV0IGkgPSBwb3MuaW5kZXg7IGkgPCB0aGlzLmtleXMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKHJpZ2h0S2V5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBpZiAob3B0cy5yaWdodEluY2x1c2l2ZSkge1xuICAgICAgICAgICAgaWYgKHRoaXMua2V5c1tpXSA+IHJpZ2h0S2V5KSB7IGJyZWFrIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRoaXMua2V5c1tpXSA+PSByaWdodEtleSkgeyBicmVhayB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMudmFsdWVzW2ldLmlzSW5kZXgpIHtcbiAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5jb25jYXQodGhpcy52YWx1ZXNbaV0uZ2V0QWxsKCkpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuY29uY2F0KHRoaXMudmFsdWVzW2ldKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG9wdHMubGltaXQpIHtcbiAgICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGggPj0gKG9wdHMubGltaXQgKyBvcHRzLm9mZnNldCkpIHtcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAobGV0IGkgPSBwb3MuaW5kZXg7IGkgPCB0aGlzLmtleXMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgbGV0IGN1cnJLZXkgPSB0aGlzLmtleXNbaV1cbiAgICAgICAgaWYgKGN1cnJLZXkgPiByaWdodEtleSkgeyBicmVhayB9XG5cbiAgICAgICAgaWYgKHRoaXMudmFsdWVzW2ldLmlzSW5kZXgpIHtcbiAgICAgICAgICBpZiAoY3VycktleSA9PT0gbGVmdEtleSkge1xuICAgICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuY29uY2F0KHRoaXMudmFsdWVzW2ldLl9iZXR3ZWVuKGNsb25lKGxlZnRLZXlzKSwgcmlnaHRLZXlzLm1hcChmdW5jdGlvbiAoKSB7IHJldHVybiB1bmRlZmluZWQgfSksIG9wdHMpKVxuICAgICAgICAgIH0gZWxzZSBpZiAoY3VycktleSA9PT0gcmlnaHRLZXkpIHtcbiAgICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmNvbmNhdCh0aGlzLnZhbHVlc1tpXS5fYmV0d2VlbihsZWZ0S2V5cy5tYXAoZnVuY3Rpb24gKCkgeyByZXR1cm4gdW5kZWZpbmVkIH0pLCBjbG9uZShyaWdodEtleXMpLCBvcHRzKSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuY29uY2F0KHRoaXMudmFsdWVzW2ldLmdldEFsbCgpKVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5jb25jYXQodGhpcy52YWx1ZXNbaV0pXG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0cy5saW1pdCkge1xuICAgICAgICAgIGlmIChyZXN1bHRzLmxlbmd0aCA+PSAob3B0cy5saW1pdCArIG9wdHMub2Zmc2V0KSkge1xuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAob3B0cy5saW1pdCkge1xuICAgICAgcmV0dXJuIHJlc3VsdHMuc2xpY2UoMCwgb3B0cy5saW1pdCArIG9wdHMub2Zmc2V0KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcmVzdWx0c1xuICAgIH1cbiAgfSxcblxuICByZW1vdmU6IGZ1bmN0aW9uIChrZXlMaXN0LCB2YWx1ZSkge1xuICAgIGlmICghaXNBcnJheShrZXlMaXN0KSkge1xuICAgICAga2V5TGlzdCA9IFtrZXlMaXN0XVxuICAgIH1cblxuICAgIGxldCBrZXkgPSBrZXlMaXN0LnNoaWZ0KClcbiAgICBsZXQgcG9zID0gYmluYXJ5U2VhcmNoKHRoaXMua2V5cywga2V5KVxuXG4gICAgaWYgKGtleUxpc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICBpZiAocG9zLmZvdW5kKSB7XG4gICAgICAgIGxldCBkYXRhTG9jYXRpb24gPSBiaW5hcnlTZWFyY2godGhpcy52YWx1ZXNbcG9zLmluZGV4XSwgdmFsdWUpXG4gICAgICAgIGlmIChkYXRhTG9jYXRpb24uZm91bmQpIHtcbiAgICAgICAgICByZW1vdmVBdCh0aGlzLnZhbHVlc1twb3MuaW5kZXhdLCBkYXRhTG9jYXRpb24uaW5kZXgpXG4gICAgICAgICAgaWYgKHRoaXMudmFsdWVzW3Bvcy5pbmRleF0ubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZW1vdmVBdCh0aGlzLmtleXMsIHBvcy5pbmRleClcbiAgICAgICAgICAgIHJlbW92ZUF0KHRoaXMudmFsdWVzLCBwb3MuaW5kZXgpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChwb3MuZm91bmQpIHtcbiAgICAgICAgdGhpcy52YWx1ZXNbcG9zLmluZGV4XS5kZWxldGUoa2V5TGlzdCwgdmFsdWUpXG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIGNsZWFyOiBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5rZXlzID0gW11cbiAgICB0aGlzLnZhbHVlcyA9IFtdXG4gIH0sXG5cbiAgaW5zZXJ0UmVjb3JkOiBmdW5jdGlvbiAoZGF0YSkge1xuICAgIGlmICghSW1tdXRhYmxlLk1hcC5pc01hcChkYXRhKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdkYXRhIG11c3QgYmUgYW4gSW1tdXRhYmxlIE1hcCcpXG4gICAgfVxuXG4gICAgbGV0IGtleUxpc3QgPSB0aGlzLmZpZWxkTGlzdC5tYXAoZnVuY3Rpb24gKGZpZWxkKSB7XG4gICAgICByZXR1cm4gZGF0YS5nZXQoZmllbGQsIG51bGwpXG4gICAgfSlcblxuICAgIHRoaXMuc2V0KGtleUxpc3QsIGRhdGEuZ2V0KCdpZCcpKVxuICB9LFxuXG4gIHJlbW92ZVJlY29yZDogZnVuY3Rpb24gKGRhdGEpIHtcbiAgICBpZiAoIUltbXV0YWJsZS5NYXAuaXNNYXAoZGF0YSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignZGF0YSBtdXN0IGJlIGFuIEltbXV0YWJsZSBNYXAnKVxuICAgIH1cblxuICAgIGxldCBrZXlMaXN0ID0gdGhpcy5maWVsZExpc3QubWFwKGZ1bmN0aW9uIChmaWVsZCkge1xuICAgICAgcmV0dXJuIGRhdGEuZ2V0KGZpZWxkLCBudWxsKVxuICAgIH0pXG5cbiAgICB0aGlzLnJlbW92ZShrZXlMaXN0LCBkYXRhLmdldCgnaWQnKSlcbiAgfSxcblxuICB1cGRhdGVSZWNvcmQ6IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgdGhpcy5yZW1vdmVSZWNvcmQoZGF0YSlcbiAgICB0aGlzLmluc2VydFJlY29yZChkYXRhKVxuICB9XG59XG5cbnZhciBjcmVhdGVJbmRleCA9IGZ1bmN0aW9uIChmaWVsZExpc3QgPSBbXSkge1xuICB2YXIgaW5kZXggPSBPYmplY3QuY3JlYXRlKEJhc2VTZWNvbmRhcnlJbmRleClcblxuICBpZiAoIWlzQXJyYXkoZmllbGRMaXN0KSkge1xuICAgIHRocm93IG5ldyBFcnJvcignZmllbGRMaXN0IG11c3QgYmUgYW4gYXJyYXkuJylcbiAgfVxuXG4gIGluZGV4LmZpZWxkTGlzdCA9IGZpZWxkTGlzdFxuICBpbmRleC5pc0luZGV4ID0gdHJ1ZVxuICBpbmRleC5rZXlzID0gW11cbiAgaW5kZXgudmFsdWVzID0gW11cblxuICByZXR1cm4gaW5kZXhcbn1cblxuZXhwb3J0IGRlZmF1bHQgY3JlYXRlSW5kZXhcbiJdfQ==