'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _utils = require('./utils');

var _isArray = require('mout/lang/isArray');

var _isArray2 = _interopRequireDefault(_isArray);

var _merge = require('mout/object/merge');

var _merge2 = _interopRequireDefault(_merge);

var _omit = require('mout/object/omit');

var _omit2 = _interopRequireDefault(_omit);

var _clone = require('mout/lang/clone');

var _clone2 = _interopRequireDefault(_clone);

var _immutable = require('immutable');

var _immutable2 = _interopRequireDefault(_immutable);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var BaseSecondaryIndex = {

  set: function set(keyList, value) {
    if (!(0, _isArray2.default)(keyList)) {
      keyList = [keyList];
    }

    var key = keyList.shift() || null;
    var pos = (0, _utils.binarySearch)(this.keys, key);

    if (keyList.length === 0) {
      if (pos.found) {
        var dataLocation = (0, _utils.binarySearch)(this.values[pos.index], value);
        if (!dataLocation.found) {
          (0, _utils.insertAt)(this.values[pos.index], dataLocation.index, value);
        }
      } else {
        (0, _utils.insertAt)(this.keys, pos.index, key);
        (0, _utils.insertAt)(this.values, pos.index, [value]);
      }
    } else {
      if (pos.found) {
        this.values[pos.index].set(keyList, value);
      } else {
        (0, _utils.insertAt)(this.keys, pos.index, key);
        var newIndex = createIndex();
        newIndex.set(keyList, value);
        (0, _utils.insertAt)(this.values, pos.index, newIndex);
      }
    }
  },

  get: function get(keyList) {
    if (!(0, _isArray2.default)(keyList)) {
      keyList = [keyList];
    }

    var key = keyList.shift() || null;
    var pos = (0, _utils.binarySearch)(this.keys, key);

    if (keyList.length === 0) {
      if (pos.found) {
        if (this.values[pos.index].isIndex) {
          return this.values[pos.index].getAll();
        } else {
          return this.values[pos.index];
        }
      } else {
        return [];
      }
    } else {
      if (pos.found) {
        return this.values[pos.index].get(keyList);
      } else {
        return [];
      }
    }
  },

  getAll: function getAll() {
    var results = [];
    this.values.forEach(function (value) {
      if (value.isIndex) {
        results = results.concat(value.getAll());
      } else {
        results = results.concat(value);
      }
    });
    return results;
  },

  query: function query(_query) {
    var leftKeys = undefined;
    var rightKeys = undefined;

    if (_query['>']) {
      leftKeys = _query['>'];
      _query.leftInclusive = false;
    } else if (_query['>=']) {
      leftKeys = _query['>='];
      _query.leftInclusive = true;
    }

    if (_query['<']) {
      rightKeys = _query['<'];
      _query.rightInclusive = false;
    } else if (_query['<=']) {
      rightKeys = _query['<='];
      _query.rightInclusive = true;
    }

    if (leftKeys.length !== rightKeys.length) {
      throw new Error('Key arrays must be same length');
    }

    return this.between(leftKeys, rightKeys, (0, _omit2.default)(_query, ['>', '>=', '<', '<=']));
  },

  between: function between(leftKeys, rightKeys, opts) {
    opts = (0, _merge2.default)({
      leftInclusive: true,
      rightInclusive: false,
      limit: undefined,
      offset: 0
    }, opts);

    var results = this._between(leftKeys, rightKeys, opts);

    if (opts.limit) {
      return results.slice(opts.offset, opts.limit + opts.offset);
    } else {
      return results.slice(opts.offset);
    }
  },

  _between: function _between(leftKeys, rightKeys, opts) {
    var results = [];

    var leftKey = leftKeys.shift();
    var rightKey = rightKeys.shift();

    var pos = undefined;

    if (leftKey !== undefined) {
      pos = (0, _utils.binarySearch)(this.keys, leftKey);
    } else {
      pos = {
        found: false,
        index: 0
      };
    }

    if (leftKeys.length === 0) {
      if (pos.found && opts.leftInclusive === false) {
        pos.index += 1;
      }

      for (var i = pos.index; i < this.keys.length; i += 1) {
        if (rightKey !== undefined) {
          if (opts.rightInclusive) {
            if (this.keys[i] > rightKey) {
              break;
            }
          } else {
            if (this.keys[i] >= rightKey) {
              break;
            }
          }
        }

        if (this.values[i].isIndex) {
          results = results.concat(this.values[i].getAll());
        } else {
          results = results.concat(this.values[i]);
        }

        if (opts.limit) {
          if (results.length >= opts.limit + opts.offset) {
            break;
          }
        }
      }
    } else {
      for (var i = pos.index; i < this.keys.length; i += 1) {
        var currKey = this.keys[i];
        if (currKey > rightKey) {
          break;
        }

        if (this.values[i].isIndex) {
          if (currKey === leftKey) {
            results = results.concat(this.values[i]._between((0, _clone2.default)(leftKeys), rightKeys.map(function () {
              return undefined;
            }), opts));
          } else if (currKey === rightKey) {
            results = results.concat(this.values[i]._between(leftKeys.map(function () {
              return undefined;
            }), (0, _clone2.default)(rightKeys), opts));
          } else {
            results = results.concat(this.values[i].getAll());
          }
        } else {
          results = results.concat(this.values[i]);
        }

        if (opts.limit) {
          if (results.length >= opts.limit + opts.offset) {
            break;
          }
        }
      }
    }

    if (opts.limit) {
      return results.slice(0, opts.limit + opts.offset);
    } else {
      return results;
    }
  },

  remove: function remove(keyList, value) {
    if (!(0, _isArray2.default)(keyList)) {
      keyList = [keyList];
    }

    var key = keyList.shift();
    var pos = (0, _utils.binarySearch)(this.keys, key);

    if (keyList.length === 0) {
      if (pos.found) {
        var dataLocation = (0, _utils.binarySearch)(this.values[pos.index], value);
        if (dataLocation.found) {
          (0, _utils.removeAt)(this.values[pos.index], dataLocation.index);
          if (this.values[pos.index].length === 0) {
            (0, _utils.removeAt)(this.keys, pos.index);
            (0, _utils.removeAt)(this.values, pos.index);
          }
        }
      }
    } else {
      if (pos.found) {
        this.values[pos.index].delete(keyList, value);
      }
    }
  },

  clear: function clear() {
    this.keys = [];
    this.values = [];
  },

  insertRecord: function insertRecord(data) {
    if (!_immutable2.default.Map.isMap(data)) {
      throw new Error('data must be an Immutable Map');
    }

    var keyList = [];
    this.fieldList.forEach(function (field) {
      var key = data.get(field, null);
      keyList.push(key);
    });

    this.set(keyList, data.get('id'));
  },

  removeRecord: function removeRecord(data) {
    if (!_immutable2.default.Map.isMap(data)) {
      throw new Error('data must be an Immutable Map');
    }

    var keyList = [];
    this.fieldList.forEach(function (field) {
      var key = data.get(field, null);
      keyList.push(key);
    });

    this.remove(keyList, data.get('id'));
  },

  updateRecord: function updateRecord(data) {
    this.removeRecord(data);
    this.insertRecord(data);
  }
};
// import isString from 'mout/lang/isString'

var createIndex = function createIndex() {
  var fieldList = arguments.length <= 0 || arguments[0] === undefined ? [] : arguments[0];

  var index = Object.create(BaseSecondaryIndex);

  if (!(0, _isArray2.default)(fieldList)) {
    throw new Error('fieldList must be an array.');
  }

  index.fieldList = fieldList;
  index.isIndex = true;
  index.keys = [];
  index.values = [];

  return index;
};

exports.default = createIndex;
//# sourceMappingURL=data:application/json;base64,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QTs7QUFFN0MsTUFBSSxDQUFDLHVCQUFRLFNBQVMsQ0FBQyxFQUFFO0FBQ3ZCLFVBQU0sSUFBSSxLQUFLLENBQUMsNkJBQTZCLENBQUMsQ0FBQTtHQUMvQzs7QUFFRCxPQUFLLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQTtBQUMzQixPQUFLLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQTtBQUNwQixPQUFLLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQTtBQUNmLE9BQUssQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFBOztBQUVqQixTQUFPLEtBQUssQ0FBQTtDQUNiLENBQUE7O2tCQUVjLFdBQVciLCJmaWxlIjoic2Vjb25kYXJ5SW5kZXguZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQge2JpbmFyeVNlYXJjaCwgaW5zZXJ0QXQsIHJlbW92ZUF0fSBmcm9tICcuL3V0aWxzJ1xuLy8gaW1wb3J0IGlzU3RyaW5nIGZyb20gJ21vdXQvbGFuZy9pc1N0cmluZydcbmltcG9ydCBpc0FycmF5IGZyb20gJ21vdXQvbGFuZy9pc0FycmF5J1xuaW1wb3J0IG1lcmdlIGZyb20gJ21vdXQvb2JqZWN0L21lcmdlJ1xuaW1wb3J0IG9taXQgZnJvbSAnbW91dC9vYmplY3Qvb21pdCdcbmltcG9ydCBjbG9uZSBmcm9tICdtb3V0L2xhbmcvY2xvbmUnXG5pbXBvcnQgSW1tdXRhYmxlIGZyb20gJ2ltbXV0YWJsZSdcblxudmFyIEJhc2VTZWNvbmRhcnlJbmRleCA9IHtcblxuICBzZXQ6IGZ1bmN0aW9uIChrZXlMaXN0LCB2YWx1ZSkge1xuICAgIGlmICghaXNBcnJheShrZXlMaXN0KSkge1xuICAgICAga2V5TGlzdCA9IFtrZXlMaXN0XVxuICAgIH1cblxuICAgIGxldCBrZXkgPSBrZXlMaXN0LnNoaWZ0KCkgfHwgbnVsbFxuICAgIGxldCBwb3MgPSBiaW5hcnlTZWFyY2godGhpcy5rZXlzLCBrZXkpXG5cbiAgICBpZiAoa2V5TGlzdC5sZW5ndGggPT09IDApIHtcbiAgICAgIGlmIChwb3MuZm91bmQpIHtcbiAgICAgICAgbGV0IGRhdGFMb2NhdGlvbiA9IGJpbmFyeVNlYXJjaCh0aGlzLnZhbHVlc1twb3MuaW5kZXhdLCB2YWx1ZSlcbiAgICAgICAgaWYgKCFkYXRhTG9jYXRpb24uZm91bmQpIHtcbiAgICAgICAgICBpbnNlcnRBdCh0aGlzLnZhbHVlc1twb3MuaW5kZXhdLCBkYXRhTG9jYXRpb24uaW5kZXgsIHZhbHVlKVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbnNlcnRBdCh0aGlzLmtleXMsIHBvcy5pbmRleCwga2V5KVxuICAgICAgICBpbnNlcnRBdCh0aGlzLnZhbHVlcywgcG9zLmluZGV4LCBbdmFsdWVdKVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAocG9zLmZvdW5kKSB7XG4gICAgICAgIHRoaXMudmFsdWVzW3Bvcy5pbmRleF0uc2V0KGtleUxpc3QsIHZhbHVlKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaW5zZXJ0QXQodGhpcy5rZXlzLCBwb3MuaW5kZXgsIGtleSlcbiAgICAgICAgbGV0IG5ld0luZGV4ID0gY3JlYXRlSW5kZXgoKVxuICAgICAgICBuZXdJbmRleC5zZXQoa2V5TGlzdCwgdmFsdWUpXG4gICAgICAgIGluc2VydEF0KHRoaXMudmFsdWVzLCBwb3MuaW5kZXgsIG5ld0luZGV4KVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICBnZXQ6IGZ1bmN0aW9uIChrZXlMaXN0KSB7XG4gICAgaWYgKCFpc0FycmF5KGtleUxpc3QpKSB7XG4gICAgICBrZXlMaXN0ID0gW2tleUxpc3RdXG4gICAgfVxuXG4gICAgbGV0IGtleSA9IGtleUxpc3Quc2hpZnQoKSB8fCBudWxsXG4gICAgbGV0IHBvcyA9IGJpbmFyeVNlYXJjaCh0aGlzLmtleXMsIGtleSlcblxuICAgIGlmIChrZXlMaXN0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgaWYgKHBvcy5mb3VuZCkge1xuICAgICAgICBpZiAodGhpcy52YWx1ZXNbcG9zLmluZGV4XS5pc0luZGV4KSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVzW3Bvcy5pbmRleF0uZ2V0QWxsKClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy52YWx1ZXNbcG9zLmluZGV4XVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gW11cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHBvcy5mb3VuZCkge1xuICAgICAgICByZXR1cm4gdGhpcy52YWx1ZXNbcG9zLmluZGV4XS5nZXQoa2V5TGlzdClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBbXVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICBnZXRBbGw6IGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgcmVzdWx0cyA9IFtdXG4gICAgdGhpcy52YWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgIGlmICh2YWx1ZS5pc0luZGV4KSB7XG4gICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmNvbmNhdCh2YWx1ZS5nZXRBbGwoKSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmNvbmNhdCh2YWx1ZSlcbiAgICAgIH1cbiAgICB9KVxuICAgIHJldHVybiByZXN1bHRzXG4gIH0sXG5cbiAgcXVlcnk6IGZ1bmN0aW9uIChxdWVyeSkge1xuICAgIGxldCBsZWZ0S2V5c1xuICAgIGxldCByaWdodEtleXNcblxuICAgIGlmIChxdWVyeVsnPiddKSB7XG4gICAgICBsZWZ0S2V5cyA9IHF1ZXJ5Wyc+J11cbiAgICAgIHF1ZXJ5LmxlZnRJbmNsdXNpdmUgPSBmYWxzZVxuICAgIH0gZWxzZSBpZiAocXVlcnlbJz49J10pIHtcbiAgICAgIGxlZnRLZXlzID0gcXVlcnlbJz49J11cbiAgICAgIHF1ZXJ5LmxlZnRJbmNsdXNpdmUgPSB0cnVlXG4gICAgfVxuXG4gICAgaWYgKHF1ZXJ5Wyc8J10pIHtcbiAgICAgIHJpZ2h0S2V5cyA9IHF1ZXJ5Wyc8J11cbiAgICAgIHF1ZXJ5LnJpZ2h0SW5jbHVzaXZlID0gZmFsc2VcbiAgICB9IGVsc2UgaWYgKHF1ZXJ5Wyc8PSddKSB7XG4gICAgICByaWdodEtleXMgPSBxdWVyeVsnPD0nXVxuICAgICAgcXVlcnkucmlnaHRJbmNsdXNpdmUgPSB0cnVlXG4gICAgfVxuXG4gICAgaWYgKGxlZnRLZXlzLmxlbmd0aCAhPT0gcmlnaHRLZXlzLmxlbmd0aCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdLZXkgYXJyYXlzIG11c3QgYmUgc2FtZSBsZW5ndGgnKVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmJldHdlZW4obGVmdEtleXMsIHJpZ2h0S2V5cywgb21pdChxdWVyeSwgWyc+JywgJz49JywgJzwnLCAnPD0nXSkpXG4gIH0sXG5cbiAgYmV0d2VlbjogZnVuY3Rpb24gKGxlZnRLZXlzLCByaWdodEtleXMsIG9wdHMpIHtcbiAgICBvcHRzID0gbWVyZ2Uoe1xuICAgICAgbGVmdEluY2x1c2l2ZTogdHJ1ZSxcbiAgICAgIHJpZ2h0SW5jbHVzaXZlOiBmYWxzZSxcbiAgICAgIGxpbWl0OiB1bmRlZmluZWQsXG4gICAgICBvZmZzZXQ6IDBcbiAgICB9LCBvcHRzKVxuXG4gICAgbGV0IHJlc3VsdHMgPSB0aGlzLl9iZXR3ZWVuKGxlZnRLZXlzLCByaWdodEtleXMsIG9wdHMpXG5cbiAgICBpZiAob3B0cy5saW1pdCkge1xuICAgICAgcmV0dXJuIHJlc3VsdHMuc2xpY2Uob3B0cy5vZmZzZXQsIG9wdHMubGltaXQgKyBvcHRzLm9mZnNldClcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHJlc3VsdHMuc2xpY2Uob3B0cy5vZmZzZXQpXG4gICAgfVxuICB9LFxuXG4gIF9iZXR3ZWVuOiBmdW5jdGlvbiAobGVmdEtleXMsIHJpZ2h0S2V5cywgb3B0cykge1xuICAgIGxldCByZXN1bHRzID0gW11cblxuICAgIGxldCBsZWZ0S2V5ID0gbGVmdEtleXMuc2hpZnQoKVxuICAgIGxldCByaWdodEtleSA9IHJpZ2h0S2V5cy5zaGlmdCgpXG5cbiAgICBsZXQgcG9zXG5cbiAgICBpZiAobGVmdEtleSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBwb3MgPSBiaW5hcnlTZWFyY2godGhpcy5rZXlzLCBsZWZ0S2V5KVxuICAgIH0gZWxzZSB7XG4gICAgICBwb3MgPSB7XG4gICAgICAgIGZvdW5kOiBmYWxzZSxcbiAgICAgICAgaW5kZXg6IDBcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobGVmdEtleXMubGVuZ3RoID09PSAwKSB7XG4gICAgICBpZiAocG9zLmZvdW5kICYmIG9wdHMubGVmdEluY2x1c2l2ZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgcG9zLmluZGV4ICs9IDFcbiAgICAgIH1cblxuICAgICAgZm9yIChsZXQgaSA9IHBvcy5pbmRleDsgaSA8IHRoaXMua2V5cy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICBpZiAocmlnaHRLZXkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGlmIChvcHRzLnJpZ2h0SW5jbHVzaXZlKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5rZXlzW2ldID4gcmlnaHRLZXkpIHsgYnJlYWsgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5rZXlzW2ldID49IHJpZ2h0S2V5KSB7IGJyZWFrIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy52YWx1ZXNbaV0uaXNJbmRleCkge1xuICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmNvbmNhdCh0aGlzLnZhbHVlc1tpXS5nZXRBbGwoKSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5jb25jYXQodGhpcy52YWx1ZXNbaV0pXG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0cy5saW1pdCkge1xuICAgICAgICAgIGlmIChyZXN1bHRzLmxlbmd0aCA+PSAob3B0cy5saW1pdCArIG9wdHMub2Zmc2V0KSkge1xuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZm9yIChsZXQgaSA9IHBvcy5pbmRleDsgaSA8IHRoaXMua2V5cy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICBsZXQgY3VycktleSA9IHRoaXMua2V5c1tpXVxuICAgICAgICBpZiAoY3VycktleSA+IHJpZ2h0S2V5KSB7IGJyZWFrIH1cblxuICAgICAgICBpZiAodGhpcy52YWx1ZXNbaV0uaXNJbmRleCkge1xuICAgICAgICAgIGlmIChjdXJyS2V5ID09PSBsZWZ0S2V5KSB7XG4gICAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5jb25jYXQodGhpcy52YWx1ZXNbaV0uX2JldHdlZW4oY2xvbmUobGVmdEtleXMpLCByaWdodEtleXMubWFwKGZ1bmN0aW9uICgpIHsgcmV0dXJuIHVuZGVmaW5lZCB9KSwgb3B0cykpXG4gICAgICAgICAgfSBlbHNlIGlmIChjdXJyS2V5ID09PSByaWdodEtleSkge1xuICAgICAgICAgICAgcmVzdWx0cyA9IHJlc3VsdHMuY29uY2F0KHRoaXMudmFsdWVzW2ldLl9iZXR3ZWVuKGxlZnRLZXlzLm1hcChmdW5jdGlvbiAoKSB7IHJldHVybiB1bmRlZmluZWQgfSksIGNsb25lKHJpZ2h0S2V5cyksIG9wdHMpKVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5jb25jYXQodGhpcy52YWx1ZXNbaV0uZ2V0QWxsKCkpXG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmNvbmNhdCh0aGlzLnZhbHVlc1tpXSlcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRzLmxpbWl0KSB7XG4gICAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID49IChvcHRzLmxpbWl0ICsgb3B0cy5vZmZzZXQpKSB7XG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChvcHRzLmxpbWl0KSB7XG4gICAgICByZXR1cm4gcmVzdWx0cy5zbGljZSgwLCBvcHRzLmxpbWl0ICsgb3B0cy5vZmZzZXQpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiByZXN1bHRzXG4gICAgfVxuICB9LFxuXG4gIHJlbW92ZTogZnVuY3Rpb24gKGtleUxpc3QsIHZhbHVlKSB7XG4gICAgaWYgKCFpc0FycmF5KGtleUxpc3QpKSB7XG4gICAgICBrZXlMaXN0ID0gW2tleUxpc3RdXG4gICAgfVxuXG4gICAgbGV0IGtleSA9IGtleUxpc3Quc2hpZnQoKVxuICAgIGxldCBwb3MgPSBiaW5hcnlTZWFyY2godGhpcy5rZXlzLCBrZXkpXG5cbiAgICBpZiAoa2V5TGlzdC5sZW5ndGggPT09IDApIHtcbiAgICAgIGlmIChwb3MuZm91bmQpIHtcbiAgICAgICAgbGV0IGRhdGFMb2NhdGlvbiA9IGJpbmFyeVNlYXJjaCh0aGlzLnZhbHVlc1twb3MuaW5kZXhdLCB2YWx1ZSlcbiAgICAgICAgaWYgKGRhdGFMb2NhdGlvbi5mb3VuZCkge1xuICAgICAgICAgIHJlbW92ZUF0KHRoaXMudmFsdWVzW3Bvcy5pbmRleF0sIGRhdGFMb2NhdGlvbi5pbmRleClcbiAgICAgICAgICBpZiAodGhpcy52YWx1ZXNbcG9zLmluZGV4XS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJlbW92ZUF0KHRoaXMua2V5cywgcG9zLmluZGV4KVxuICAgICAgICAgICAgcmVtb3ZlQXQodGhpcy52YWx1ZXMsIHBvcy5pbmRleClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHBvcy5mb3VuZCkge1xuICAgICAgICB0aGlzLnZhbHVlc1twb3MuaW5kZXhdLmRlbGV0ZShrZXlMaXN0LCB2YWx1ZSlcbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgY2xlYXI6IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmtleXMgPSBbXVxuICAgIHRoaXMudmFsdWVzID0gW11cbiAgfSxcblxuICBpbnNlcnRSZWNvcmQ6IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgaWYgKCFJbW11dGFibGUuTWFwLmlzTWFwKGRhdGEpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2RhdGEgbXVzdCBiZSBhbiBJbW11dGFibGUgTWFwJylcbiAgICB9XG5cbiAgICBsZXQga2V5TGlzdCA9IFtdXG4gICAgdGhpcy5maWVsZExpc3QuZm9yRWFjaChmdW5jdGlvbiAoZmllbGQpIHtcbiAgICAgIGxldCBrZXkgPSBkYXRhLmdldChmaWVsZCwgbnVsbClcbiAgICAgIGtleUxpc3QucHVzaChrZXkpXG4gICAgfSlcblxuICAgIHRoaXMuc2V0KGtleUxpc3QsIGRhdGEuZ2V0KCdpZCcpKVxuICB9LFxuXG4gIHJlbW92ZVJlY29yZDogZnVuY3Rpb24gKGRhdGEpIHtcbiAgICBpZiAoIUltbXV0YWJsZS5NYXAuaXNNYXAoZGF0YSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignZGF0YSBtdXN0IGJlIGFuIEltbXV0YWJsZSBNYXAnKVxuICAgIH1cblxuICAgIGxldCBrZXlMaXN0ID0gW11cbiAgICB0aGlzLmZpZWxkTGlzdC5mb3JFYWNoKGZ1bmN0aW9uIChmaWVsZCkge1xuICAgICAgbGV0IGtleSA9IGRhdGEuZ2V0KGZpZWxkLCBudWxsKVxuICAgICAga2V5TGlzdC5wdXNoKGtleSlcbiAgICB9KVxuXG4gICAgdGhpcy5yZW1vdmUoa2V5TGlzdCwgZGF0YS5nZXQoJ2lkJykpXG4gIH0sXG5cbiAgdXBkYXRlUmVjb3JkOiBmdW5jdGlvbiAoZGF0YSkge1xuICAgIHRoaXMucmVtb3ZlUmVjb3JkKGRhdGEpXG4gICAgdGhpcy5pbnNlcnRSZWNvcmQoZGF0YSlcbiAgfVxufVxuXG52YXIgY3JlYXRlSW5kZXggPSBmdW5jdGlvbiAoZmllbGRMaXN0ID0gW10pIHtcbiAgdmFyIGluZGV4ID0gT2JqZWN0LmNyZWF0ZShCYXNlU2Vjb25kYXJ5SW5kZXgpXG5cbiAgaWYgKCFpc0FycmF5KGZpZWxkTGlzdCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2ZpZWxkTGlzdCBtdXN0IGJlIGFuIGFycmF5LicpXG4gIH1cblxuICBpbmRleC5maWVsZExpc3QgPSBmaWVsZExpc3RcbiAgaW5kZXguaXNJbmRleCA9IHRydWVcbiAgaW5kZXgua2V5cyA9IFtdXG4gIGluZGV4LnZhbHVlcyA9IFtdXG5cbiAgcmV0dXJuIGluZGV4XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNyZWF0ZUluZGV4XG4iXX0=